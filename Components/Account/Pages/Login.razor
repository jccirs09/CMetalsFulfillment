@page "/Account/Login"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Identity
@using CMetalsFulfillment.Data

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject ILogger<Login> Logger
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>MetalFlow Secure Login</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex justify-center align-center" Style="height: 80vh;">
    <MudCard Elevation="5" Class="rounded-lg pa-4" Style="width: 100%; max-width: 450px; background-color: var(--mud-palette-surface);">
        <MudCardHeader Class="d-flex flex-column align-center">
            <div class="d-flex justify-center align-center rounded-lg pa-3 mb-4" style="background-color: rgba(19, 91, 236, 0.1); border: 1px solid rgba(19, 91, 236, 0.2);">
                <MudIcon Icon="@Icons.Material.Filled.Security" Color="Color.Primary" Size="Size.Large" />
            </div>
            <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight: 700;">MetalFlow Systems</MudText>
            <MudText Typo="Typo.caption" Align="Align.Center" Color="Color.Secondary">Secure Industrial Access Portal</MudText>
        </MudCardHeader>

        <MudCardContent>
            <StatusMessage Message="@errorMessage" />

            <EditForm EditContext="editContext" OnSubmit="LoginUser" FormName="login">
                <DataAnnotationsValidator />

                <MudTextField @bind-Value="Input.LoginIdentifier"
                              Label="Email or Username"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Person"
                              Class="mb-4"
                              For="@(() => Input.LoginIdentifier)"
                              Required="true"
                              RequiredError="Email or Username is required." />

                <MudTextField @bind-Value="Input.Password"
                              Label="Password"
                              Variant="Variant.Outlined"
                              InputType="@_passwordInputType"
                              Adornment="Adornment.End"
                              AdornmentIcon="@_passwordVisibilityIcon"
                              OnAdornmentClick="TogglePasswordVisibility"
                              AdornmentAriaLabel="Show Password"
                              Class="mb-4"
                              For="@(() => Input.Password)"
                              Required="true"
                              RequiredError="Password is required." />

                <div class="d-flex justify-space-between align-center mb-4">
                    <MudCheckBox @bind-Value="Input.RememberMe" Label="Remember me" Color="Color.Primary" Dense="true" />
                    <MudLink Href="Account/ForgotPassword" Typo="Typo.body2" Color="Color.Primary">Forgot password?</MudLink>
                </div>

                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           Size="Size.Large"
                           FullWidth="true"
                           StartIcon="@Icons.Material.Filled.Login"
                           Class="py-2">
                    SECURE LOGIN
                </MudButton>
            </EditForm>
        </MudCardContent>

        <MudCardActions Class="d-flex justify-center pt-4 pb-2">
             <MudText Typo="Typo.caption" Color="Color.Secondary">
                Need access credentials? <MudLink Href="#" Typo="Typo.caption" Color="Color.Inherit" Underline="Underline.Always">Contact SysAdmin</MudLink>
             </MudText>
        </MudCardActions>
    </MudCard>
</MudContainer>

<div style="position: fixed; bottom: 0; width: 100%; padding: 10px 20px; background-color: var(--mud-palette-surface); border-top: 1px solid var(--mud-palette-lines-default); z-index: 10;">
    <div class="d-flex justify-space-between align-center">
        <div class="d-flex align-center gap-2">
             <div style="width: 8px; height: 8px; border-radius: 50%; background-color: #4caf50; animation: pulse 2s infinite;"></div>
             <MudText Typo="Typo.caption" Color="Color.Secondary">System Status: Operational</MudText>
        </div>
        <div class="d-flex align-center gap-4">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Â© 2024 MetalFlow Systems</MudText>
            <MudDivider Vertical="true" FlexItem="true" />
            <MudText Typo="Typo.caption" Color="Color.Secondary">Version 2.4.0 (Build 892)</MudText>
             <MudDivider Vertical="true" FlexItem="true" />
             <div class="d-flex align-center">
                 <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Small" Color="Color.Secondary" Class="mr-1" style="font-size: 14px;" />
                 <MudText Typo="Typo.caption" Color="Color.Secondary">256-bit SSL Encrypted</MudText>
             </div>
        </div>
    </div>
</div>

@code {
    private string? errorMessage;
    private EditContext editContext = default!;

    bool _passwordVisibility;
    InputType _passwordInputType = InputType.Password;
    string _passwordVisibilityIcon = Icons.Material.Filled.VisibilityOff;

    void TogglePasswordVisibility()
    {
        @if(_passwordVisibility)
        {
            _passwordVisibility = false;
            _passwordVisibilityIcon = Icons.Material.Filled.VisibilityOff;
            _passwordInputType = InputType.Password;
        }
        else
        {
            _passwordVisibility = true;
            _passwordVisibilityIcon = Icons.Material.Filled.Visibility;
            _passwordInputType = InputType.Text;
        }
    }

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();
        editContext = new EditContext(Input);

        if (HttpMethods.IsGet(HttpContext.Request.Method))
        {
            await HttpContext.SignOutAsync(IdentityConstants.ExternalScheme);
        }
    }

    public async Task LoginUser()
    {
        if (!editContext.Validate())
        {
            return;
        }

        string userNameToSignIn = Input.LoginIdentifier;

        // Custom Logic: Check if input is email
        if (Input.LoginIdentifier.Contains("@"))
        {
            var user = await UserManager.FindByEmailAsync(Input.LoginIdentifier);
            if (user != null)
            {
                userNameToSignIn = user.UserName ?? string.Empty;
            }
        }

        // This doesn't count login failures towards account lockout
        // To enable password failures to trigger account lockout, set lockoutOnFailure: true
        var result = await SignInManager.PasswordSignInAsync(userNameToSignIn ?? string.Empty, Input.Password, Input.RememberMe, lockoutOnFailure: false);

        if (result.Succeeded)
        {
            Logger.LogInformation("User logged in.");
            RedirectManager.RedirectTo(ReturnUrl);
        }
        else if (result.RequiresTwoFactor)
        {
            RedirectManager.RedirectTo(
                "Account/LoginWith2fa",
                new() { ["returnUrl"] = ReturnUrl, ["rememberMe"] = Input.RememberMe });
        }
        else if (result.IsLockedOut)
        {
            Logger.LogWarning("User account locked out.");
            RedirectManager.RedirectTo("Account/Lockout");
        }
        else
        {
            errorMessage = "Error: Invalid login attempt.";
        }
    }

    private sealed class InputModel
    {
        [Required]
        [Display(Name = "Email or Username")]
        public string LoginIdentifier { get; set; } = "";

        [Required]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [Display(Name = "Remember me?")]
        public bool RememberMe { get; set; }
    }
}
