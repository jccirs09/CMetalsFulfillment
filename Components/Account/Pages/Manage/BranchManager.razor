@using Microsoft.EntityFrameworkCore
@using CMetalsFulfillment.Data
@using CMetalsFulfillment.Data.Entities
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudCard Elevation="4" Class="pa-4">
    <MudCardHeader>
        <CardHeaderContent>
             <MudText Typo="Typo.h6">Branch Memberships</MudText>
             <MudText Typo="Typo.body2" Color="Color.Secondary">Manage your access and set your default working branch.</MudText>
        </CardHeaderContent>
         <CardHeaderActions>
            <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Add" Color="Color.Primary" Size="Size.Small" OnClick="OpenJoinDialog">Join New Branch</MudButton>
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        @if (_loading)
        {
             <MudProgressCircular Indeterminate="true" />
        }
        else if (_memberships != null && _memberships.Any())
        {
            <MudList T="string" >
                @foreach (var membership in _memberships)
                {
                    <MudListItem Class="mb-2 rounded-lg" Style="background-color: var(--mud-palette-background-grey);">
                         <div class="d-flex align-center w-100">
                            <MudIcon Icon="@Icons.Material.Filled.Business" Color="Color.Primary" Class="mr-4" />
                            <div class="flex-grow-1">
                                <div class="d-flex align-center">
                                    <MudText Typo="Typo.subtitle1" Class="mr-2">@membership.Branch.Name</MudText>
                                    @if (membership.IsDefaultForUser)
                                    {
                                        <MudChip T="string" Color="Color.Warning" Size="Size.Small" Variant="Variant.Outlined">Default</MudChip>
                                    }
                                    else
                                    {
                                         <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Default" OnClick="@(() => SetDefault(membership.Id))">Set Default</MudButton>
                                    }
                                </div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Role: @(GetRoleName(membership))</MudText>
                            </div>
                             @if (membership.IsDefaultForUser)
                             {
                                  <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Primary" Size="Size.Small" />
                                  <MudText Typo="Typo.caption" Color="Color.Primary" Class="ml-1">Current Default</MudText>
                             }
                        </div>
                    </MudListItem>
                }
            </MudList>
        }
        else
        {
            <MudText>No memberships found.</MudText>
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter] public string UserId { get; set; } = "";
    private List<UserBranchMembership> _memberships = new();
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        using var context = await DbFactory.CreateDbContextAsync();
        _memberships = await context.UserBranchMemberships
            .Include(m => m.Branch)
            .Where(m => m.UserId == UserId && m.IsActive)
            .ToListAsync();
        _loading = false;
    }

    private string GetRoleName(UserBranchMembership membership)
    {
        return "Member";
    }

    private async Task SetDefault(int membershipId)
    {
        using var context = await DbFactory.CreateDbContextAsync();
        var all = await context.UserBranchMemberships.Where(m => m.UserId == UserId).ToListAsync();
        foreach (var m in all)
        {
            m.IsDefaultForUser = (m.Id == membershipId);
        }
        await context.SaveChangesAsync();
        await LoadData();
        Snackbar.Add("Default branch updated", Severity.Success);
    }

    private async Task OpenJoinDialog()
    {
        Snackbar.Add("Join Branch functionality coming soon", Severity.Info);
    }
}
