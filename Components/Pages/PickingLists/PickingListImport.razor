@page "/picking-lists/import"
@using CMetalsFulfillment.Features.PickingLists
@using System.Net.Http.Json
@using System.Net.Http.Headers
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager NavManager

<MudText Typo="Typo.h4" GutterBottom="true">Import Picking List</MudText>

<MudPaper Class="pa-4">
    <InputFile id="plFileInput" OnChange="UploadFile" hidden />
    <MudButton HtmlTag="label"
               Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.CloudUpload"
               for="plFileInput">
        Upload JSON
    </MudButton>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-4" />
    }
</MudPaper>

@code {
    private bool _loading = false;

    private async Task UploadFile(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        _loading = true;
        try
        {
            // Read JSON from file
            using var stream = file.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024); // 2MB
            var dto = await System.Text.Json.JsonSerializer.DeserializeAsync<ImportPlDto>(stream, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (dto == null)
            {
                Snackbar.Add("Invalid JSON", Severity.Error);
                _loading = false;
                return;
            }

            var response = await Http.PostAsJsonAsync("api/pl/import", dto);
            if (response.IsSuccessStatusCode)
            {
                var uid = await response.Content.ReadFromJsonAsync<Guid>();
                Snackbar.Add("Picking List Imported", Severity.Success);
                NavManager.NavigateTo($"/picking-lists/{uid}");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Import failed: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
             Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        _loading = false;
    }
}
