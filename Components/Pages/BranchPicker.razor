@using CMetalsFulfillment.Data.Entities
@using CMetalsFulfillment.Services
@inject BranchService BranchService
@inject IBranchContext BranchContext
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavManager
@inject CookieService CookieService

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">Select Branch</MudText>
        @if (_branches == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else
        {
            <MudList T="Branch" SelectionMode="SelectionMode.SingleSelection" SelectedValueChanged="OnBranchSelected">
                @foreach (var branch in _branches)
                {
                    <MudListItem Value="@branch">
                        <div class="d-flex justify-space-between">
                            <MudText>@branch.Name (@branch.Code)</MudText>
                            <MudText Typo="Typo.caption">@branch.City</MudText>
                        </div>
                    </MudListItem>
                }
            </MudList>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    private List<Branch>? _branches;
    private string? _userId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _userId = user.FindFirst("mf:userId")?.Value ?? user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (_userId != null)
        {
            _branches = await BranchService.GetUserBranchesAsync(_userId);

            if (user.HasClaim(c => c.Type == "mf:isSystemAdmin"))
            {
                 var allBranches = await BranchService.GetActiveBranchesAsync();
                 _branches = allBranches;
            }
        }
    }

    private async Task OnBranchSelected(Branch branch)
    {
        if (branch != null)
        {
            await CookieService.SetCookieAsync("mf.branch", branch.Id.ToString(), 30);
            BranchContext.SetBranch(branch.Id, branch.Code, branch.TimeZoneId);
            MudDialog.Close(DialogResult.Ok(branch.Id));
            NavManager.NavigateTo(NavManager.GetUriWithQueryParameter("branchId", branch.Id), forceLoad: true);
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
