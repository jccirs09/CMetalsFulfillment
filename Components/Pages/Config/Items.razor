@page "/admin/items"
@using CMetalsFulfillment.Domain
@using System.Net.Http.Json
@using System.Net.Http.Headers
@inject HttpClient Http
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" GutterBottom="true">Item Master</MudText>

<div class="d-flex align-center gap-4 mb-4">
    <InputFile id="fileInput" OnChange="UploadFiles" hidden />
    <MudButton HtmlTag="label"
               Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.CloudUpload"
               for="fileInput">
        Import Items
    </MudButton>
    <MudSpacer />
    <MudTextField @bind-Value="_searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
</div>

<MudTable Items="@_items" Hover="true" Filter="new Func<Item,bool>(FilterFunc)" Loading="@_loading">
    <HeaderContent>
        <MudTh>Item Code</MudTh>
        <MudTh>Description</MudTh>
        <MudTh>Coil Rel</MudTh>
        <MudTh>UOM</MudTh>
        <MudTh>PPSF</MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Code">@context.ItemCode</MudTd>
        <MudTd DataLabel="Description">@context.Description</MudTd>
        <MudTd DataLabel="Coil Rel">@context.CoilRelationship</MudTd>
        <MudTd DataLabel="UOM">@context.UOM</MudTd>
        <MudTd DataLabel="PPSF">@context.PoundsPerSquareFoot</MudTd>
        <MudTd DataLabel="Actions">
            <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => EditPpsf(context))">Edit PPSF</MudButton>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    private List<Item> _items = new();
    private string _searchString = "";
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadItems();
    }

    private async Task LoadItems()
    {
        _loading = true;
        try
        {
            _items = await Http.GetFromJsonAsync<List<Item>>("api/items") ?? new List<Item>();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading items: {ex.Message}", Severity.Error);
        }
        _loading = false;
    }

    private bool FilterFunc(Item item)
    {
        if (string.IsNullOrWhiteSpace(_searchString)) return true;
        if (item.ItemCode.Contains(_searchString, StringComparison.OrdinalIgnoreCase)) return true;
        if (item.Description != null && item.Description.Contains(_searchString, StringComparison.OrdinalIgnoreCase)) return true;
        return false;
    }

    private async Task UploadFiles(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        var content = new MultipartFormDataContent();
        var fileContent = new StreamContent(file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024)); // 10MB limit
        fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType);
        content.Add(fileContent, "file", file.Name);

        _loading = true;
        try
        {
            var response = await Http.PostAsync("api/items/import", content);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Import successful", Severity.Success);
                await LoadItems();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Import failed: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
             Snackbar.Add($"Error uploading: {ex.Message}", Severity.Error);
        }
        _loading = false;
    }

    private async Task EditPpsf(Item item)
    {
        var parameters = new DialogParameters { ["Item"] = item };
        var dialog = DialogService.Show<PpsfDialog>("Edit PPSF", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadItems();
        }
    }
}
