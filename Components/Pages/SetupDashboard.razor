@page "/setup"
@using CMetalsFulfillment.Services
@using CMetalsFulfillment.Data
@inject ISetupStatusService SetupStatusService
@inject IBranchContext BranchContext
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudText Typo="Typo.h4" GutterBottom="true">Setup Dashboard</MudText>
    @if (BranchContext.ActiveBranchId.HasValue)
    {
        <MudText Typo="Typo.h6">Current Branch: @BranchContext.ActiveBranchCode (@BranchContext.ActiveBranchId)</MudText>

        <MudGrid Class="mt-4">
            @foreach (var gate in _gates)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard>
                        <MudCardHeader>
                            <CardHeaderAvatar>
                                <MudIcon Icon="@(gate.Value ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)" Color="@(gate.Value ? Color.Success : Color.Error)" />
                            </CardHeaderAvatar>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@FormatKey(gate.Key)</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                             <MudText>Status: @(gate.Value ? "Complete" : "Incomplete")</MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Text" Color="Color.Primary" Disabled="@(!IsAdmin)">Manage</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else
    {
        <MudAlert Severity="Severity.Warning">Please select a branch first.</MudAlert>
    }
</MudContainer>

@code {
    private Dictionary<string, bool> _gates = new();
    private bool IsAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        IsAdmin = user.IsInRole("SystemAdmin") || user.HasClaim(c => c.Type == "mf:isSystemAdmin");

        if (BranchContext.ActiveBranchId.HasValue)
        {
            _gates = await SetupStatusService.GetGateStatusAsync(BranchContext.ActiveBranchId.Value);
        }
    }

    private string FormatKey(string key)
    {
        // Simple formatter
        return System.Text.RegularExpressions.Regex.Replace(key, "([a-z])([A-Z])", "$1 $2");
    }
}
