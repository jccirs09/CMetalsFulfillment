@page "/admin/inventory/import"
@using System.Net.Http.Headers
@inject HttpClient Http
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" GutterBottom="true">Import Inventory Snapshot</MudText>

<MudPaper Class="pa-4">
    <InputFile id="fileInput" OnChange="UploadFiles" hidden />
    <MudButton HtmlTag="label"
               Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.CloudUpload"
               for="fileInput">
        Select Snapshot File
    </MudButton>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-4" />
    }
</MudPaper>

@if (_result != null)
{
    <MudCard Class="mt-4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Import Result</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudText>Matched Rows: <b>@_result.MatchedRows</b></MudText>
            <MudText>Unmatched Rows: <b>@_result.UnmatchedRows</b></MudText>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="@($"/admin/inventory/snapshots/{_result.Id}")" Class="mt-2">View Details</MudButton>
        </MudCardContent>
    </MudCard>
}

@code {
    private bool _loading = false;
    private ImportResult? _result;

    private async Task UploadFiles(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        var content = new MultipartFormDataContent();
        var fileContent = new StreamContent(file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024)); // 10MB limit
        fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType);
        content.Add(fileContent, "file", file.Name);

        _loading = true;
        _result = null;
        try
        {
            var response = await Http.PostAsync("api/inventory/import", content);
            if (response.IsSuccessStatusCode)
            {
                _result = await response.Content.ReadFromJsonAsync<ImportResult>();
                Snackbar.Add("Import successful", Severity.Success);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Import failed: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
             Snackbar.Add($"Error uploading: {ex.Message}", Severity.Error);
        }
        _loading = false;
    }

    public class ImportResult
    {
        public int Id { get; set; }
        public int MatchedRows { get; set; }
        public int UnmatchedRows { get; set; }
    }
}
